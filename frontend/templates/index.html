<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>超导文献数据库 - 元素周期表</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom shadow-sm sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/">超导文献数据库</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                    </li>
                </ul>
                <div class="d-flex align-items-center" id="user-nav">
                    <!-- 登录/注册按钮将由 JS 动态生成 -->
                    <div class="spinner-border spinner-border-sm text-light" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- 头部 -->
        <header class="py-4 text-center">
            <h1 class="display-4 fw-bold text-dark">超导文献数据库</h1>
            <p class="lead text-dark">基于元素周期表的超导材料文献检索系统</p>
        </header>

        <!-- 亮点图片展示 (诺贝尔奖得主) -->
        <div class="image-grid-nobel mb-4">
            <div class="grid-item"><img src="/static/img/nobel/Kamerlingh_portret.jpg" title="Heike Kamerlingh Onnes" alt="Kamerlingh Onnes"></div>
            <div class="grid-item"><img src="/static/img/nobel/Bardeen.jpg" title="John Bardeen" alt="John Bardeen"></div>
            <div class="grid-item"><img src="/static/img/nobel/Laureate_Leon_Cooper.jpg" title="Leon Cooper" alt="Leon Cooper"></div>
            <div class="grid-item"><img src="/static/img/nobel/John_Robert_Schrieffer.jpg" title="John Robert Schrieffer" alt="John Robert Schrieffer"></div>
            <div class="grid-item"><img src="/static/img/nobel/Ivar_Giaever.jpg" title="Ivar Giaever" alt="Ivar Giaever"></div>
            <div class="grid-item"><img src="/static/img/nobel/Brian_Josephson,_March_2004.jpg" title="Brian Josephson" alt="Brian Josephson"></div>
            
            <div class="grid-item"><img src="/static/img/nobel/Leo_Esaki_1959.jpg" title="Leo Esaki" alt="Leo Esaki"></div>
            <div class="grid-item"><img src="/static/img/nobel/Georg_Bednorz_speaking_at_the_groundbreaking_of_the_new_IBM_and_ETH_Zurich_Nanotech_Exploratory_Technology_Lab.jpg" title="Georg Bednorz" alt="Georg Bednorz"></div>
            <div class="grid-item"><img src="/static/img/nobel/Karl_Alexander_Mueller.jpg" title="Karl Müller" alt="Karl Müller"></div>
            <div class="grid-item"><img src="/static/img/nobel/AA_Abrikosov_ANL1.jpg" title="Alexei Abrikosov" alt="Alexei Abrikosov"></div>
            <div class="grid-item"><img src="/static/img/nobel/Ginzburg_in_MSU_opaque.jpg" title="Vitaly Ginzburg" alt="Vitaly Ginzburg"></div>
            <div class="grid-item"><img src="/static/img/nobel/Nobel_Laureate_Sir_Anthony_James_Leggett_in_2007.jpg" title="Anthony James Leggett" alt="Anthony James Leggett"></div>
        </div>

        <!-- 选择提示区域 -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5>已选元素：<span id="selected-elements" class="badge bg-primary">未选择</span></h5>
                        <p class="text-muted mb-2">点击元素进行选择，选中后再次点击可取消。选择完成后点击下方按钮或按Enter键进入化合物页面。</p>
                        <div class="mb-3">
                            <label class="form-label text-muted">筛选条件</label>
                            <div class="btn-group w-100" role="group" aria-label="元素筛选模式">
                                <input type="radio" class="btn-check" name="selection-mode" id="mode-only" value="only">
                                <label class="btn btn-outline-primary" for="mode-only">仅包含选择元素</label>

                                <input type="radio" class="btn-check" name="selection-mode" id="mode-combination" value="combination" checked>
                                <label class="btn btn-outline-primary" for="mode-combination">选择元素的组合</label>

                                <input type="radio" class="btn-check" name="selection-mode" id="mode-contains" value="contains">
                                <label class="btn btn-outline-primary" for="mode-contains">包含所选元素</label>
                            </div>
                        </div>
                        <button id="enter-compound-btn" class="btn btn-success" disabled>进入化合物页面</button>
                        <button id="clear-selection-btn" class="btn btn-secondary">清除选择</button>
                        
                        <!-- 快速上传下拉菜单 -->
                        <div class="dropdown d-inline-block ms-1">
                            <button class="btn btn-outline-info dropdown-toggle" type="button" id="fastUploadDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-cloud-upload"></i> 快速上传
                            </button>
                            <ul class="dropdown-menu shadow" aria-labelledby="fastUploadDropdown">
                                <li><a class="dropdown-item" href="#" onclick="triggerFastUpload(); return false;">🚀 快速上传 (xlsx, csv, txt)</a></li>
                                <li><a class="dropdown-item" href="#" onclick="downloadFastUploadExample(); return false;">📄 快速上传示例 (.xlsx)</a></li>
                            </ul>
                        </div>
                        <input type="file" id="fast-upload-input" style="display: none;" accept=".xlsx,.csv,.txt" onchange="handleFastUpload(this)">
                    </div>
                </div>
            </div>
        </div>

        <!-- 元素周期表 -->
        <div class="row">
            <div class="col-12">
                <div class="periodic-table-container">
                    <div id="periodic-table"></div>
                </div>
            </div>
        </div>

        <!-- 数据统计展示区域 -->
        <div class="row mt-4 mb-4">
            <!-- 历史趋势图 (基于 Book1.xls) -->
            <div class="col-12 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-light py-2">
                        <h6 class="card-title mb-0 fw-bold">超导临界温度 (Tc) 历史演变</h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="ratio" style="--bs-aspect-ratio: 50%;">
                            <canvas id="staticChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 数据库实时 P-Tc 分布 -->
            <div class="col-12 mb-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-light py-2">
                        <h6 class="card-title mb-0 fw-bold">数据库实时 P-Tc 分布</h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="ratio" style="--bs-aspect-ratio: 50%;">
                            <canvas id="dynamicChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 贡献者排行 -->
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-header bg-light py-2">
                        <h6 class="card-title mb-0 fw-bold">贡献者排行 (Top 20)</h6>
                    </div>
                    <div class="card-body p-2">
                        <div style="height: 500px;">
                            <canvas id="rankingChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 使用说明 -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-body">
                        <h5>使用说明</h5>
                        <ul>
                            <li>选择一个或多个元素，系统将显示含有这些元素的超导体文献</li>
                            <li>选择多个元素时，显示<strong>同时包含所有选中元素</strong>的化合物文献</li>
                            <li>如果元素组合暂无文献，系统会提示您重新选择</li>
                            <li>支持键盘Enter键快捷跳转</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 开发者信息 -->
        <div class="row mt-3 mb-4">
            <div class="col-md-12">
                <div class="text-center text-muted">
                    <p class="mb-1">开发者：吉林大学物理学院 马原</p>
                    <p class="mb-0">邮箱：<a href="mailto:mayuan@calypso.org.cn">mayuan@calypso.org.cn</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 图片查看模态框 -->
    <div class="modal fade" id="imageViewModal" tabindex="-1">
        <div class="modal-dialog modal-xl modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-0">
                    <img id="fullSizeImage" src="" class="img-fluid" alt="全屏图">
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script src="/static/js/chart.js" defer></script>
    <script src="/static/js/auth_state.js"></script>
    <script src="/static/js/auth_helper.js"></script>
    <script src="/static/js/periodic_table.js"></script>
    <script>
        // 性能优先：确保周期表先渲染，延迟初始化图表和交互
        window.addEventListener('load', function() {
            // 辅助函数：将数字、x、括号转换为下标（仅用于物质名称）
            const formatSubscript = (str) => {
                if (!str) return '';
                const map = {
                    '0':'₀','1':'₁','2':'₂','3':'₃','4':'₄','5':'₅','6':'₆','7':'₇','8':'₈','9':'₉',
                    'x':'ₓ','(':'₍',')':'₎','[':'₍',']':'₎','-':'₋','+':'₊'
                };
                return str.split('').map(c => map[c] || c).join('');
            };

            setTimeout(function() {
                if (typeof Chart === 'undefined') return;

                // 辅助函数：获取 CSS 变量值
                const getCSSVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();
                
                // 从 CSS 获取颜色和形状
                const colors = {
                    cuprate: getCSSVar('--sc-color-cuprate'),
                    iron: getCSSVar('--sc-color-iron'),
                    nickel: getCSSVar('--sc-color-nickel'),
                    hydride: getCSSVar('--sc-color-hydride'),
                    carbon: getCSSVar('--sc-color-carbon'),
                    organic: getCSSVar('--sc-color-organic'),
                    others: getCSSVar('--sc-color-others'),
                    unknown: getCSSVar('--sc-color-unknown')
                };
                const shapes = {
                    experimental: getCSSVar('--sc-shape-experimental'),
                    theoretical: getCSSVar('--sc-shape-theoretical')
                };
                const chartAspectRatio = 2;
                // 1. 左侧图表：超导历史 Tc 演变 (基于数据库数据)
                const ctxStatic = document.getElementById('staticChart').getContext('2d');
                const staticChart = new Chart(ctxStatic, {
                    type: 'scatter',
                    data: {
                        datasets: [
                            {
                                label: '实验数据',
                                data: [],
                                borderColor: '#fff',
                                borderWidth: 1,
                                pointRadius: 4,
                                pointStyle: shapes.experimental,
                                order: 0
                            },
                            {
                                label: '理论预测',
                                data: [],
                                borderColor: '#fff',
                                borderWidth: 1,
                                pointRadius: 5,
                                pointStyle: shapes.theoretical,
                                order: 0
                            },
                            // 虚拟数据集用于显示图例
                            { label: 'Legend: 铜基', backgroundColor: colors.cuprate, data: [], pointStyle: 'rect' },
                            { label: 'Legend: 铁基', backgroundColor: colors.iron, data: [], pointStyle: 'rect' },
                            { label: 'Legend: 镍基', backgroundColor: colors.nickel, data: [], pointStyle: 'rect' },
                            { label: 'Legend: 高压氢化物', backgroundColor: colors.hydride, data: [], pointStyle: 'rect' },
                            { label: 'Legend: 碳基', backgroundColor: colors.carbon, data: [], pointStyle: 'rect' },
                            { label: 'Legend: 有机', backgroundColor: colors.organic, data: [], pointStyle: 'rect' },
                            { label: 'Legend: 其他超导', backgroundColor: colors.others, data: [], pointStyle: 'rect' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2,
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'bottom',
                                title: { display: true, text: '年份' },
                                min: 1900,
                                max: 2040
                            },
                            y: {
                                title: { display: true, text: '临界温度 Tc (K)' },
                                beginAtZero: true,
                                max: 400
                            }
                        },
                        plugins: {
                            legend: { 
                                position: 'bottom', 
                                labels: { 
                                    color: '#666',
                                    usePointStyle: true,
                                    boxWidth: 10, 
                                    font: { size: 10 },
                                    generateLabels: (chart) => {
                                        const originalLabels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                        return originalLabels.map(item => {
                                            if (item.text.startsWith('Legend: ')) {
                                                item.text = item.text.replace('Legend: ', '');
                                            }
                                            if (item.text === '实验数据' || item.text === '理论预测') {
                                                item.fillStyle = '#6c757d';
                                                item.strokeStyle = '#6c757d';
                                            }
                                            return item;
                                        });
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const p = context.raw;
                                        return `${p.label}: ${p.y} K (${p.year})`;
                                    }
                                }
                            }
                        }
                    },
                    plugins: [{
                        id: 'chartCustomizations',
                        beforeDraw: (chart) => {
                            const {ctx, chartArea: {right, left}, scales: {y}} = chart;
                            ctx.save();
                            const drawLine = (val, color, text) => {
                                const yPos = y.getPixelForValue(val);
                                if (yPos < chart.chartArea.top || yPos > chart.chartArea.bottom) return;
                                ctx.strokeStyle = color;
                                ctx.setLineDash([5, 5]);
                                ctx.beginPath();
                                ctx.moveTo(left, yPos);
                                ctx.lineTo(right, yPos);
                                ctx.stroke();
                                ctx.fillStyle = color;
                                ctx.font = '10px Arial';
                                ctx.fillText(text, left + 5, yPos - 5);
                            };
                            drawLine(77, 'rgba(255, 0, 0, 0.5)', '77 K (Liquid N2)');
                            drawLine(300, 'rgba(0, 0, 0, 0.3)', '300 K (Room Temp)');
                            ctx.restore();
                        },
                        afterDatasetsDraw: (chart) => {
                            if (window.innerWidth < 800) return;
                            const {ctx} = chart;
                            ctx.save();
                            ctx.font = '9px Arial';
                            ctx.fillStyle = '#666';
                            chart.data.datasets.forEach((dataset, i) => {
                                if (i > 1) return; // 只处理实验数据和理论预测
                                const meta = chart.getDatasetMeta(i);
                                meta.data.forEach((element, index) => {
                                    const p = dataset.data[index];
                                    if (!p) return;
                                    const text = `${formatSubscript(p.label)} (${p.pressure} GPa)`;
                                    if (element.x > chart.chartArea.left && element.x < chart.chartArea.right) {
                                        ctx.fillText(text, element.x + 6, element.y - 4);
                                    }
                                });
                            });
                            ctx.restore();
                        }
                    }]
                });

                // 2. 右侧图表：数据库实时 P-Tc 分布 (散点图)
                const ctxDynamic = document.getElementById('dynamicChart').getContext('2d');
                
                // 辅助函数：生成 s 因子曲线数据
                const generateSLine = (s) => {
                    const points = [];
                    for (let p = 0; p <= 300; p += 10) {
                        const tc = s * Math.sqrt(1521 + Math.pow(p, 2));
                        points.push({ x: p, y: tc });
                    }
                    return points;
                };

                const dynamicChart = new Chart(ctxDynamic, {
                    type: 'scatter',
                    data: {
                        datasets: [
                            // s 因子参考线与背景填充 (从大到小排列以实现层叠填充)
                            { label: 's=1', data: generateSLine(1), borderColor: 'rgba(0,0,0,0.1)', borderWidth: 1, borderDash: [5, 5], showLine: true, pointRadius: 0, fill: 'origin', backgroundColor: '#f7f0f7', order: 1 },
                            { label: 's=2', data: generateSLine(2), borderColor: 'rgba(0,0,0,0.1)', borderWidth: 1, borderDash: [5, 5], showLine: true, pointRadius: 0, fill: 'origin', backgroundColor: '#e3e0ee', order: 2 },
                            { label: 's=3', data: generateSLine(3), borderColor: 'rgba(0,0,0,0.1)', borderWidth: 1, borderDash: [5, 5], showLine: true, pointRadius: 0, fill: 'origin', backgroundColor: '#c6cce3', order: 3 },
                            { label: 's=4', data: generateSLine(4), borderColor: 'rgba(0,0,0,0.1)', borderWidth: 1, borderDash: [5, 5], showLine: true, pointRadius: 0, fill: 'origin', backgroundColor: '#a1bbda', order: 4 },
                            { label: 's=5', data: generateSLine(5), borderColor: 'rgba(0,0,0,0.1)', borderWidth: 0, borderDash: [5, 5], showLine: true, pointRadius: 0, fill: 'origin', backgroundColor: '#73a9cf', order: 5 },
                            { label: 's=6', data: generateSLine(6), borderColor: 'rgba(0,0,0,0.1)', borderWidth: 0, borderDash: [5, 5], showLine: true, pointRadius: 0, fill: 'origin', backgroundColor: '#3d93c2', order: 6 },
                            { label: 's=7', data: generateSLine(7), borderColor: 'rgba(0,0,0,0.1)', borderWidth: 0, borderDash: [5, 5], showLine: true, pointRadius: 0, fill: 'origin', backgroundColor: '#1077b4', order: 7 },
                            { label: 's=8', data: generateSLine(8), borderColor: 'rgba(0,0,0,0.1)', borderWidth: 0, borderDash: [5, 5], showLine: true, pointRadius: 0, fill: 'origin', backgroundColor: '#046198', order: 8 },
                            { label: 's=9', data: generateSLine(9), borderColor: 'rgba(0,0,0,0.1)', borderWidth: 0, borderDash: [5, 5], showLine: true, pointRadius: 0, fill: 'origin', backgroundColor: '#03476f', order: 9 },
                            { label: 's=10', data: generateSLine(10), borderColor: 'rgba(0,0,0,0.1)', borderWidth: 0, borderDash: [5, 5], showLine: true, pointRadius: 0, fill: 'origin', backgroundColor: '#02304d', order: 10 },

                            {
                                label: '实验数据',
                                data: [],
                                borderColor: '#fff',
                                borderWidth: 1,
                                pointRadius: 4,
                                pointStyle: shapes.experimental,
                            },
                            {
                                label: '理论预测',
                                data: [],
                                borderColor: '#fff',
                                borderWidth: 1,
                                pointRadius: 5,
                                pointStyle: shapes.theoretical,
                            },
                            // 虚拟数据集用于显示图例
                            { label: 'Legend: 铜基', backgroundColor: colors.cuprate, data: [], pointStyle: 'rect' },
                            { label: 'Legend: 铁基', backgroundColor: colors.iron, data: [], pointStyle: 'rect' },
                            { label: 'Legend: 镍基', backgroundColor: colors.nickel, data: [], pointStyle: 'rect' },
                            { label: 'Legend: 高压氢化物', backgroundColor: colors.hydride, data: [], pointStyle: 'rect' },
                            { label: 'Legend: 碳基', backgroundColor: colors.carbon, data: [], pointStyle: 'rect' },
                            { label: 'Legend: 有机', backgroundColor: colors.organic, data: [], pointStyle: 'rect' },
                            { label: 'Legend: 其他超导', backgroundColor: colors.others, data: [], pointStyle: 'rect' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2,
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'bottom',
                                title: { display: true, text: '压强 (GPa)' },
                                min: -0.01,
                                max: 300
                            },
                            y: {
                                title: { display: true, text: '临界温度 Tc (K)' },
                                min: 0,
                                max: 350
                            }
                        },
                        plugins: {
                            legend: { 
                                position: 'bottom', 
                                labels: { 
                                    color: '#666',
                                    usePointStyle: true,
                                    boxWidth: 10, 
                                    font: { size: 10 },
                                    // 过滤掉 s 曲线，并美化虚拟图例标签
                                    generateLabels: (chart) => {
                                        const originalLabels = Chart.defaults.plugins.legend.labels.generateLabels(chart);
                                        return originalLabels
                                            .filter(item => !item.text.startsWith('s='))
                                            .map(item => {
                                                if (item.text.startsWith('Legend: ')) {
                                                    item.text = item.text.replace('Legend: ', '');
                                                }
                                                if (item.text === '实验数据' || item.text === '理论预测') {
                                                    item.fillStyle = '#6c757d';
                                                    item.strokeStyle = '#6c757d';
                                                }
                                                return item;
                                            });
                                    }
                                } 
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const p = context.raw;
                                        if (!p.label) return null;
                                        return `${p.label}: ${p.y} K @ ${p.x} GPa`;
                                    }
                                }
                            }
                        }
                    },
                    plugins: [{
                        id: 'sLabelPlugin',
                        afterDatasetsDraw: (chart) => {
                            const {ctx, scales: {x, y}} = chart;
                            ctx.save();
                            
                            // 1. 绘制 s 因子标签
                            ctx.font = 'bold 10px Arial';
                            ctx.fillStyle = 'rgba(0,0,0,0.3)';
                            [1, 2, 3, 4, 5, 6, 7, 8, 9, 10].forEach(s => {
                                let p = 280;
                                let tc = s * Math.sqrt(1521 + Math.pow(p, 2));
                                if (tc > 330) {
                                    const val = Math.pow(330/s, 2) - 1521;
                                    p = val > 0 ? Math.sqrt(val) : 10;
                                    tc = 335;
                                }
                                const xPos = x.getPixelForValue(p);
                                const yPos = y.getPixelForValue(tc);
                                if (xPos > chart.chartArea.left && xPos < chart.chartArea.right &&
                                    yPos > chart.chartArea.top && yPos < chart.chartArea.bottom) {
                                    if (s <= 5) ctx.fillText(`s=${s}`, xPos, yPos - 10);
                                }
                            });

                            // 2. 大屏显示数据点名称和年份
                            if (window.innerWidth >= 800) {
                                ctx.font = '9px Arial';
                                ctx.fillStyle = '#666';
                                chart.data.datasets.forEach((dataset, i) => {
                                    if (i !== 10 && i !== 11) return; // 只处理实验数据和理论预测
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        const p = dataset.data[index];
                                        if (!p) return;
                                        const text = `${formatSubscript(p.label)} (${p.year})`;
                                        if (element.x > chart.chartArea.left && element.x < chart.chartArea.right) {
                                            ctx.fillText(text, element.x + 6, element.y - 4);
                                        }
                                    });
                                });
                            }
                            ctx.restore();
                        }
                    }]
                });

                // 加载数据库实时数据
                fetch('/api/papers/stats/chart-data')
                    .then(response => response.json())
                    .then(data => {
                        if (!Array.isArray(data)) return;

                        const scColorMap = {
                            'cuprate': colors.cuprate,
                            'iron_based': colors.iron,
                            'nickel_based': colors.nickel,
                            'hydride': colors.hydride,
                            'carbon': colors.carbon,
                            'organic': colors.organic,
                            'others': colors.others,
                        };

                        const expData = data.filter(d => d.type === 'experimental');
                        const theoData = data.filter(d => d.type === 'theoretical');
                        
                        // 1. 更新左侧图表 (Tc vs Year)
                        const expDataYear = expData.map(d => ({ x: d.year, y: d.y, label: d.label, year: d.year, pressure: d.x }));
                        const theoDataYear = theoData.map(d => ({ x: d.year, y: d.y, label: d.label, year: d.year, pressure: d.x }));
                        
                        const expColors = expData.map(d => scColorMap[d.sc_type] || colors.unknown);
                        const theoColors = theoData.map(d => scColorMap[d.sc_type] || colors.unknown);

                        staticChart.data.datasets[0].data = expDataYear;
                        staticChart.data.datasets[0].backgroundColor = expColors;
                        staticChart.data.datasets[0].pointBackgroundColor = expColors;
                        
                        staticChart.data.datasets[1].data = theoDataYear;
                        staticChart.data.datasets[1].backgroundColor = theoColors;
                        staticChart.data.datasets[1].pointBackgroundColor = theoColors;
                        staticChart.update();

                        // 2. 更新右侧图表 (Tc vs Pressure)
                        dynamicChart.data.datasets[10].data = expData;
                        dynamicChart.data.datasets[10].backgroundColor = expColors;
                        dynamicChart.data.datasets[10].pointBackgroundColor = expColors;
                        
                        dynamicChart.data.datasets[11].data = theoData;
                        dynamicChart.data.datasets[11].backgroundColor = theoColors;
                        dynamicChart.data.datasets[11].pointBackgroundColor = theoColors;
                        
                        dynamicChart.update();
                    })
                    .catch(err => console.error('加载图表数据失败:', err));

                // 3. 贡献者排行图表 (横向柱状图)
                const ctxRanking = document.getElementById('rankingChart').getContext('2d');
                const rankingChart = new Chart(ctxRanking, {
                    type: 'bar',
                    data: {
                        labels: Array(20).fill(''), // 预留20个位置
                        datasets: [{
                            label: '提交文献数',
                            data: Array(20).fill(null),
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1,
                            barThickness: 15 // 固定柱子宽度更美观
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                beginAtZero: true,
                                title: { display: true, text: '文献提交数量' },
                                ticks: { stepSize: 1 }
                            },
                            y: {
                                ticks: {
                                    font: { weight: 'bold' },
                                    autoSkip: false
                                },
                                grid: { display: false }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.raw === null) return null;
                                        return ` 提交了 ${context.raw} 篇文献`;
                                    }
                                }
                            }
                        }
                    }
                });

                // 加载排行榜数据
                fetch('/api/papers/stats/user-ranking')
                    .then(response => response.json())
                    .then(data => {
                        if (!Array.isArray(data) || data.length === 0) return;
                        
                        // 准备20个名额的数据
                        const displayLabels = Array(20).fill('');
                        const displayData = Array(20).fill(null);
                        let maxVal = 0;

                        data.forEach((item, i) => {
                            if (i < 20) {
                                displayLabels[i] = item.name;
                                displayData[i] = item.count;
                                if (item.count > maxVal) maxVal = item.count;
                            }
                        });

                        // 更新 X 轴范围：最大值的 1.5 倍向上取整
                        const xAxisMax = Math.ceil((maxVal || 1) * 1.5);
                        rankingChart.options.scales.x.max = xAxisMax;

                        rankingChart.data.labels = displayLabels;
                        rankingChart.data.datasets[0].data = displayData;
                        rankingChart.update();
                    })
                    .catch(err => console.error('加载排行榜失败:', err));
            }, 300);
        });
    </script>
</body>
</html>
