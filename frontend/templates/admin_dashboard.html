<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜é¢æ¿ - è¶…å¯¼æ–‡çŒ®æ•°æ®åº“</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-dark navbar-custom sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">è¶…å¯¼æ–‡çŒ®æ•°æ®åº“</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="/admin/dashboard">å®¡æ ¸æ–‡çŒ®</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/papers">å…¨å±€ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/admin/my-reviews">æˆ‘å®¡æ ¸çš„æ–‡çŒ®</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center text-white">
                    <span class="me-3">æ¬¢è¿ï¼Œ<span id="userName"></span></span>
                    <button class="btn btn-outline-light btn-sm" onclick="logout()">é€€å‡º</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <h2>å¾…å®¡æ ¸æ–‡çŒ®åˆ—è¡¨</h2>

        <div id="unreviewedPapers" class="mt-4">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                </div>
                <p class="mt-3">æ­£åœ¨åŠ è½½...</p>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘æ–‡çŒ®æ¨¡æ€æ¡† -->
    <div class="modal fade" id="editPaperModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ç¼–è¾‘æ–‡çŒ®ä¿¡æ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editPaperForm">
                        <input type="hidden" id="editPaperId">

                        <div class="mb-3">
                            <label class="form-label">DOI <small class="text-muted">(åªè¯»)</small></label>
                            <input type="text" class="form-control" id="editDoi" readonly>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">æ ‡é¢˜ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="editTitle" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">æœŸåˆŠ</label>
                                <input type="text" class="form-control" id="editJournal">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">å¹´ä»½</label>
                                <input type="number" class="form-control" id="editYear" min="1900" max="2100">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">å·å·</label>
                                <input type="text" class="form-control" id="editVolume">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ä½œè€…</label>
                            <textarea class="form-control" id="editAuthors" rows="2"></textarea>
                            <small class="text-muted">JSONæ ¼å¼ï¼Œå¦‚ï¼š["å¼ ä¸‰", "æå››"]</small>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">æ–‡ç« ç±»å‹</label>
                                <select class="form-select" id="editArticleType">
                                    <option value="theoretical">ç†è®º</option>
                                    <option value="experimental">å®éªŒ</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">è¶…å¯¼ä½“ç±»å‹</label>
                                <select class="form-select" id="editSuperconductorType">
                                    <option value="conventional">å¸¸è§„</option>
                                    <option value="unconventional">éå¸¸è§„</option>
                                    <option value="unknown">æœªçŸ¥</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">åŒ–å­¦å¼</label>
                                <input type="text" class="form-control" id="editChemicalFormula">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">æ™¶ä½“ç»“æ„</label>
                                <input type="text" class="form-control" id="editCrystalStructure">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">ç‰©ç†æ•°æ® (å‹å¼º/Tc/Î»ç­‰) <span class="text-danger">*</span></label>
                            <div id="editDataPointsContainer">
                                <!-- åŠ¨æ€æ•°æ®è¡Œ -->
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-1" onclick="addEditDataRow()">+ æ·»åŠ ä¸€ç»„æ•°æ®</button>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">è´¡çŒ®è€…</label>
                                <input type="text" class="form-control" id="editContributorName">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">è´¡çŒ®è€…å•ä½</label>
                                <input type="text" class="form-control" id="editContributorAffiliation">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">å¤‡æ³¨</label>
                            <textarea class="form-control" id="editNotes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" onclick="savePaperEdits()">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </div>
        </div>
    </div>

    <script src="/static/js/bootstrap.bundle.min.js"></script>
    <script>
        let token = '';
        let currentUser = null;
        let editModal = null;

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkAuth() {
            token = localStorage.getItem('admin_token');
            const userStr = localStorage.getItem('admin_user');

            if (!token || !userStr) {
                alert('è¯·å…ˆç™»å½•');
                window.location.href = '/admin/login';
                return false;
            }

            currentUser = JSON.parse(userStr);
            document.getElementById('userName').textContent = currentUser.real_name;
            return true;
        }

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_user');
            window.location.href = '/admin/login';
        }

        // åŠ è½½æœªå®¡æ ¸æ–‡çŒ®
        async function loadUnreviewedPapers() {
            try {
                const response = await fetch('/api/admin/papers/unreviewed?limit=100', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('åŠ è½½å¤±è´¥');
                }

                const data = await response.json();
                renderPapers(data.papers, data.total);
            } catch (error) {
                console.error('åŠ è½½æ–‡çŒ®å¤±è´¥:', error);
                document.getElementById('unreviewedPapers').innerHTML = `
                    <div class="alert alert-danger">åŠ è½½å¤±è´¥: ${error.message}</div>
                `;
            }
        }

        // æ¸²æŸ“æ–‡çŒ®åˆ—è¡¨
        function renderPapers(papers, total) {
            const container = document.getElementById('unreviewedPapers');

            if (papers.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success text-center">
                        <h4>ğŸ‰ å¤ªæ£’äº†ï¼</h4>
                        <p class="mb-0">ç›®å‰æ²¡æœ‰å¾…å®¡æ ¸çš„æ–‡çŒ®</p>
                    </div>
                `;
                return;
            }

            let html = `<p class="text-muted">å…± ${total} ç¯‡å¾…å®¡æ ¸æ–‡çŒ®</p>`;

            papers.forEach(paper => {
                // HTMLè½¬ä¹‰å‡½æ•°ï¼Œé˜²æ­¢XSSå’Œå¼•å·é—®é¢˜
                const escapeHtml = (str) => {
                    const div = document.createElement('div');
                    div.textContent = str;
                    return div.innerHTML;
                };

                const safeTitle = escapeHtml(paper.title);
                const safeJournal = escapeHtml(paper.journal || 'æœªçŸ¥');
                const safeContributor = escapeHtml(paper.contributor_name);

                // æ„å»ºæŒ‰é’®ç»„ï¼ˆæ ¹æ®ç”¨æˆ·è§’è‰²æ˜¾ç¤ºä¸åŒæŒ‰é’®ï¼‰
                let buttons = `
                    <a href="https://doi.org/${paper.doi}" target="_blank" class="btn btn-sm btn-outline-primary">æŸ¥çœ‹åŸæ–‡</a>
                    <button class="btn btn-sm btn-warning btn-edit" data-paper-id="${paper.id}">è¯¦æƒ…/ç¼–è¾‘</button>
                    <button class="btn btn-sm btn-success btn-approve" data-paper-id="${paper.id}" data-paper-title="${safeTitle}">é€šè¿‡</button>
                    <button class="btn btn-sm btn-danger btn-reject" data-paper-id="${paper.id}" data-paper-title="${safeTitle}">æ‹’ç»</button>
                `;

                // å¦‚æœæ˜¯è¶…çº§ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºåˆ é™¤æŒ‰é’®
                if (currentUser && currentUser.is_superadmin) {
                    buttons += `<button class="btn btn-sm btn-danger btn-delete" data-paper-id="${paper.id}" data-paper-doi="${paper.doi}" data-paper-title="${safeTitle}">åˆ é™¤</button>`;
                }

                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">${safeTitle}</h5>
                            <p class="text-muted mb-2">
                                <strong>DOI:</strong> ${paper.doi}<br>
                                <strong>æœŸåˆŠ:</strong> ${safeJournal} (${paper.year || 'æœªçŸ¥å¹´ä»½'})<br>
                                <strong>Tc / P:</strong> ${paper.tc ? paper.tc + ' K' : '-'} / ${paper.pressure ? paper.pressure + ' GPa' : '-'}<br>
                                <strong>è´¡çŒ®è€…:</strong> ${safeContributor}<br>
                                <strong>æäº¤æ—¶é—´:</strong> ${new Date(paper.created_at).toLocaleString('zh-CN')}
                            </p>
                            <div class="d-flex gap-2 flex-wrap">
                                ${buttons}
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;

            // ç»‘å®šäº‹ä»¶
            container.querySelectorAll('.btn-approve').forEach(btn => {
                btn.addEventListener('click', function() {
                    const paperId = this.getAttribute('data-paper-id');
                    const paperTitle = this.getAttribute('data-paper-title');
                    reviewPaper(paperId, paperTitle, 'approved');
                });
            });

            container.querySelectorAll('.btn-reject').forEach(btn => {
                btn.addEventListener('click', function() {
                    const paperId = this.getAttribute('data-paper-id');
                    const paperTitle = this.getAttribute('data-paper-title');
                    reviewPaper(paperId, paperTitle, 'rejected');
                });
            });

            container.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const paperId = this.getAttribute('data-paper-id');
                    openEditModal(paperId);
                });
            });

            container.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const paperId = this.getAttribute('data-paper-id');
                    const paperDoi = this.getAttribute('data-paper-doi');
                    const paperTitle = this.getAttribute('data-paper-title');
                    deletePaper(paperId, paperDoi, paperTitle);
                });
            });
        }

        // å®¡æ ¸æ–‡çŒ®
        async function reviewPaper(paperId, title, status = 'approved') {
            const statusText = status === 'approved' ? 'é€šè¿‡' : 'æ‹’ç»';
            if (!confirm(`ç¡®è®¤æ ‡è®°ã€Š${title}ã€‹ä¸º${statusText}ï¼Ÿ`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/papers/${paperId}/review`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        status: status,
                        comment: ''
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(`å·²æ ‡è®°ä¸º${statusText}ï¼`);
                    loadUnreviewedPapers(); // é‡æ–°åŠ è½½åˆ—è¡¨
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + (data.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('å®¡æ ¸å¤±è´¥:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // ç¼–è¾‘æ–‡çŒ®åŠ©æ‰‹å‡½æ•°
        function addEditDataRow(data = null) {
            const container = document.getElementById('editDataPointsContainer');
            const row = document.createElement('div');
            row.className = 'edit-data-row card p-2 mb-2 bg-light';
            row.innerHTML = `
                <div class="row g-2">
                    <div class="col-md-3">
                        <input type="number" step="any" class="form-control form-control-sm edit-pressure" placeholder="P (GPa)" value="${data ? data.pressure || '' : ''}">
                    </div>
                    <div class="col-md-3">
                        <input type="number" step="any" class="form-control form-control-sm edit-tc" placeholder="Tc (K)" value="${data ? data.tc || '' : ''}">
                    </div>
                    <div class="col-md-2">
                        <input type="number" step="any" class="form-control form-control-sm edit-lambda" placeholder="Î»" value="${data ? data.lambda_val || '' : ''}">
                    </div>
                    <div class="col-md-2">
                        <input type="number" step="any" class="form-control form-control-sm edit-omega" placeholder="Ï‰" value="${data ? data.omega_log || '' : ''}">
                    </div>
                    <div class="col-md-1">
                        <input type="number" step="any" class="form-control form-control-sm edit-nef" placeholder="N" value="${data ? data.n_ef || '' : ''}">
                    </div>
                    <div class="col-md-1">
                        <button type="button" class="btn btn-outline-danger btn-sm w-100" onclick="removeEditDataRow(this)">Ã—</button>
                    </div>
                </div>
            `;
            container.appendChild(row);
        }

        function removeEditDataRow(button) {
            const container = document.getElementById('editDataPointsContainer');
            if (container.querySelectorAll('.edit-data-row').length > 1) {
                button.closest('.edit-data-row').remove();
            } else {
                alert('è‡³å°‘éœ€è¦ä¿ç•™ä¸€ç»„æ•°æ®');
            }
        }

        // æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        async function openEditModal(paperId) {
            try {
                const response = await fetch(`/api/admin/papers/${paperId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('è·å–æ–‡çŒ®ä¿¡æ¯å¤±è´¥');
                }

                const paper = await response.json();

                // å¡«å……è¡¨å•
                document.getElementById('editPaperId').value = paper.id;
                document.getElementById('editDoi').value = paper.doi;
                document.getElementById('editTitle').value = paper.title || '';
                document.getElementById('editJournal').value = paper.journal || '';
                document.getElementById('editYear').value = paper.year || '';
                document.getElementById('editVolume').value = paper.volume || '';
                document.getElementById('editAuthors').value = paper.authors || '';
                document.getElementById('editArticleType').value = paper.article_type || 'experimental';
                document.getElementById('editSuperconductorType').value = paper.superconductor_type || 'unknown';
                document.getElementById('editChemicalFormula').value = paper.chemical_formula || '';
                document.getElementById('editCrystalStructure').value = paper.crystal_structure || '';
                
                // å¡«å……ç‰©ç†æ•°æ®
                const dataContainer = document.getElementById('editDataPointsContainer');
                dataContainer.innerHTML = '';
                if (paper.data && paper.data.length > 0) {
                    paper.data.forEach(d => addEditDataRow(d));
                } else {
                    addEditDataRow();
                }

                document.getElementById('editContributorName').value = paper.contributor_name || '';
                document.getElementById('editContributorAffiliation').value = paper.contributor_affiliation || '';
                document.getElementById('editNotes').value = paper.notes || '';

                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                if (!editModal) {
                    editModal = new bootstrap.Modal(document.getElementById('editPaperModal'));
                }
                editModal.show();

            } catch (error) {
                console.error('æ‰“å¼€ç¼–è¾‘æ¡†å¤±è´¥:', error);
                alert('æ— æ³•æ‰“å¼€ç¼–è¾‘æ¡†: ' + error.message);
            }
        }

        // ä¿å­˜ç¼–è¾‘
        async function savePaperEdits() {
            const paperId = document.getElementById('editPaperId').value;

            // æ”¶é›†ç‰©ç†æ•°æ®
            const physicalData = [];
            document.querySelectorAll('.edit-data-row').forEach(row => {
                const pressure = row.querySelector('.edit-pressure').value;
                const tc = row.querySelector('.edit-tc').value;
                if (pressure && tc) {
                    physicalData.push({
                        pressure: parseFloat(pressure),
                        tc: parseFloat(tc),
                        lambda_val: row.querySelector('.edit-lambda').value ? parseFloat(row.querySelector('.edit-lambda').value) : null,
                        omega_log: row.querySelector('.edit-omega').value ? parseFloat(row.querySelector('.edit-omega').value) : null,
                        n_ef: row.querySelector('.edit-nef').value ? parseFloat(row.querySelector('.edit-nef').value) : null
                    });
                }
            });

            const updateData = {
                title: document.getElementById('editTitle').value,
                journal: document.getElementById('editJournal').value,
                year: document.getElementById('editYear').value ? parseInt(document.getElementById('editYear').value) : null,
                volume: document.getElementById('editVolume').value,
                authors: document.getElementById('editAuthors').value,
                article_type: document.getElementById('editArticleType').value,
                superconductor_type: document.getElementById('editSuperconductorType').value,
                chemical_formula: document.getElementById('editChemicalFormula').value,
                crystal_structure: document.getElementById('editCrystalStructure').value,
                physical_data: physicalData,
                contributor_name: document.getElementById('editContributorName').value,
                contributor_affiliation: document.getElementById('editContributorAffiliation').value,
                notes: document.getElementById('editNotes').value
            };

            try {
                const response = await fetch(`/api/admin/papers/${paperId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                const data = await response.json();

                if (response.ok) {
                    alert('æ–‡çŒ®ä¿¡æ¯å·²æ›´æ–°ï¼');
                    editModal.hide();
                    loadUnreviewedPapers(); // é‡æ–°åŠ è½½åˆ—è¡¨
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + (data.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // åˆ é™¤æ–‡çŒ®ï¼ˆä¸‰é‡ç¡®è®¤ï¼‰
        async function deletePaper(paperId, paperDoi, paperTitle) {
            // ç¬¬ä¸€æ¬¡ç¡®è®¤
            if (!confirm(`âš ï¸ è­¦å‘Šï¼šç¡®å®šè¦åˆ é™¤æ–‡çŒ®ã€Š${paperTitle}ã€‹å—ï¼Ÿ\n\næ­¤æ“ä½œå°†åˆ é™¤è¯¥æ–‡çŒ®åŠå…¶æ‰€æœ‰æˆªå›¾ï¼Œä¸”ä¸å¯æ’¤é”€ï¼`)) {
                return;
            }

            // ç¬¬äºŒæ¬¡ç¡®è®¤ï¼šè¾“å…¥DOIéªŒè¯
            const inputDoi = prompt(`è¯·è¾“å…¥è¯¥æ–‡çŒ®çš„DOIä»¥ç¡®è®¤åˆ é™¤ï¼š\n\n${paperDoi}`);
            if (inputDoi !== paperDoi) {
                alert('DOIä¸åŒ¹é…ï¼Œåˆ é™¤å·²å–æ¶ˆ');
                return;
            }

            // ç¬¬ä¸‰æ¬¡ç¡®è®¤
            if (!confirm(`æœ€åç¡®è®¤ï¼šçœŸçš„è¦åˆ é™¤ã€Š${paperTitle}ã€‹å—ï¼Ÿ\n\nâš ï¸ æ­¤æ“ä½œä¸å¯æ’¤é”€ï¼`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/papers/${paperId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (response.ok) {
                    alert('æ–‡çŒ®å·²åˆ é™¤ï¼');
                    loadUnreviewedPapers(); // é‡æ–°åŠ è½½åˆ—è¡¨
                } else {
                    alert('åˆ é™¤å¤±è´¥: ' + (data.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('åˆ é™¤å¤±è´¥:', error);
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        if (checkAuth()) {
            loadUnreviewedPapers();
        }
    </script>
</body>
</html>
